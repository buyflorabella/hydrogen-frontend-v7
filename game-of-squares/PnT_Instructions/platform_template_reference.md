# Platform Template Reference Guide

**Created:** 2026-02-10
**Purpose:** Importable guidance for any program that creates new websites based on the platform-template
**Source:** `/opt/operations/platform-template/`

---

## 1. What This Document Is

This is a complete structural and behavioral specification of the **platform-template** — a reusable Flask + React scaffolding located at `/opt/operations/platform-template/`. Any program creating a new website MUST clone this template and follow its conventions exactly. This document describes every file, every convention, and every pattern so that new sites are structurally identical to the template.

---

## 2. When to Use the Platform Template

Use platform-template as the starting point for **every** new website. The workflow is:

1. Clone `platform-template/` into a new repository named after the site
2. Configure the site in `site-management/group_vars/all/ports.yml` (port allocation)
3. Run Ansible from `site-management/` to generate environment-specific settings files
4. Develop the site by adding routes, components, and business logic to the cloned scaffold

**Never build a site from scratch.** Always start from the template.

---

## 3. Complete Directory Structure

```
platform-template/
├── backend/                          # Flask application
│   ├── app.py                        # Main Flask entry point with CORS and health endpoint
│   ├── config.py                     # Configuration class reading environment variables
│   ├── requirements.txt              # Python dependencies
│   └── templates/                    # Reserved for Jinja2 HTML templates (empty by default)
│
├── frontend/                         # React + Vite application
│   ├── index.html                    # HTML entry point with <div id="root">
│   ├── package.json                  # NPM dependencies and build scripts
│   ├── vite.config.js                # Vite build configuration with React plugin
│   ├── .env.example                  # Template showing required VITE_* variables
│   ├── .gitignore                    # Ignores node_modules/, dist/, .env
│   └── src/
│       ├── main.jsx                  # React root renderer (mounts <App /> to #root)
│       ├── App.jsx                   # Main component with backend health-check demo
│       └── components/               # Reserved for React components (empty by default)
│
├── script/                           # Configuration and launcher scripts
│   ├── settings.txt                  # Shared non-secret defaults (all environments)
│   ├── settings.sh                   # Auto-detector: sources correct env file based on PWD
│   ├── settings.dev.sh               # Dev environment overrides   (GENERATED BY ANSIBLE)
│   ├── settings.staging.sh           # Staging environment overrides (GENERATED BY ANSIBLE)
│   ├── settings.prod.sh              # Prod environment overrides  (GENERATED BY ANSIBLE)
│   ├── manage.sh                     # Main entry point: --frontend / --backend / --gunicorn
│   ├── run-backend.sh                # Sources settings, exports env vars, runs Flask
│   ├── run-frontend.sh               # Sources settings, generates .env, runs Vite dev server
│   ├── run-gunicorn.sh               # Sources settings, runs Gunicorn with eventlet workers
│   └── generate-env.sh              # Generates frontend/.env and root .env from settings
│
├── systemd/                          # Example systemd configuration (templates)
│   ├── site.service.example          # Systemd unit file template for Gunicorn
│   └── site.env.example              # Environment file template for systemd
│
├── .gitignore                        # Project-level git ignores
└── README.md                         # Quick-start documentation
```

**Total: 21 tracked files across 4 top-level directories.**

---

## 4. File-by-File Specification

### 4.1 Backend — `/backend/`

#### `app.py` — Flask Entry Point
- Initializes Flask app and loads `config.Config`
- Enables CORS via `flask_cors` restricted to domains from `ALLOWED_CORS_DOMAINS` env var
- Provides a single health-check endpoint: `GET /api/health`
  - Returns JSON: `{ "status": "healthy", "environment": "<ENV>" }`
- Reads host/port from environment: `BACKEND_HOST` (default `127.0.0.1`), `BACKEND_PORT` (default `5001`)
- Debug mode controlled by `DEBUG` env var
- **New sites**: Add new routes and blueprints here. Keep the health endpoint intact.

#### `config.py` — Configuration Class
- Single `Config` class with attributes read from `os.environ.get()`
- Variables: `SECRET_KEY`, `ALLOWED_CORS_DOMAINS`, `BACKEND_HOST`, `BACKEND_PORT`
- All have safe defaults for local development
- **Convention**: Never hardcode secrets. Always read from environment.

#### `requirements.txt` — Python Dependencies
```
flask
flask_cors
gunicorn
eventlet
```
- These four are the minimum. Add project-specific deps below them.
- **Do not remove** any of the four base dependencies.

#### `templates/` — Jinja2 HTML Templates
- Empty by default. Reserved for server-rendered HTML if needed.
- Most sites use React for the frontend, so this stays empty.

---

### 4.2 Frontend — `/frontend/`

#### `package.json` — NPM Configuration
- **Runtime deps**: `react@^19`, `react-dom@^19`, `react-router-dom@^7`
- **Dev deps**: `@vitejs/plugin-react@^5`, `vite@^7`
- Module type: `"type": "module"`
- Scripts: `dev` (Vite dev server), `build` (production build), `lint`, `preview`

#### `vite.config.js` — Vite Build Config
- Uses `@vitejs/plugin-react`
- Dev server port read from `process.env.VITE_FRONTEND_PORT`
- `allowedHosts` can be configured for external access (commented example provided)

#### `index.html` — HTML Entry Point
- Contains `<div id="root"></div>` mount point
- Loads `/src/main.jsx` as ES module
- **Keep minimal.** All rendering happens in React.

#### `.env.example` — Environment Variable Template
```
VITE_API_BASE_URL=http://localhost:15101
VITE_FRONTEND_PORT=15100
VITE_BACKEND_PORT=15101
VITE_ENV=development
```
- Shows required variables. Actual `.env` is generated by `generate-env.sh`.
- **All frontend env vars MUST use `VITE_` prefix** (Vite requirement for build-time exposure).

#### `src/main.jsx` — React Root Renderer
- Renders `<App />` into `#root` element
- Uses `createRoot` from React 19

#### `src/App.jsx` — Main Application Component
- Demonstrates backend connectivity via health-check fetch
- Uses `import.meta.env.VITE_API_BASE_URL` for API URL
- **New sites**: Replace the health-check demo with actual application UI.

#### `src/components/` — Component Directory
- Empty by default. Organize React components here.
- **Convention**: PascalCase filenames (e.g., `UserProfile.jsx`, `NavBar.jsx`)

---

### 4.3 Scripts — `/script/`

This is the configuration and orchestration layer. **Scripts are the glue between Ansible-generated config and the running application.**

#### Configuration Flow (critical to understand)

```
settings.txt          Shared defaults (checked into git)
     │
     v
settings.sh           Auto-detector (checked into git)
     │  inspects $PWD to determine environment
     │  sources settings.txt FIRST
     │  then sources the correct environment file:
     ├──> settings.dev.sh        (GENERATED by Ansible, git-ignored)
     ├──> settings.staging.sh    (GENERATED by Ansible, git-ignored)
     └──> settings.prod.sh       (GENERATED by Ansible, git-ignored)
              │
              v
         manage.sh               Dispatcher (checked into git)
              │  receives --frontend, --backend, or --gunicorn
              ├──> run-frontend.sh  ──> generate-env.sh ──> npm run dev
              ├──> run-backend.sh   ──> generate-env.sh ──> python3 app.py
              └──> run-gunicorn.sh  ──> gunicorn -k eventlet ...
```

#### `settings.txt` — Shared Defaults
Non-secret configuration shared across all environments:
```bash
FRONTEND_DIR="frontend"
FRONTEND_HOST=localhost
PYTHON_BIN="python3"
WORKERS=3
BACKEND_DIR="backend"
BACKEND_APP_SCRIPT=app
BACKEND_HOST="127.0.0.1"
ALLOWED_CORS_DOMAINS=""
```
- **Never put secrets here.** This file is checked into git.
- New sites may add shared (non-secret) config variables here.

#### `settings.sh` — Environment Auto-Detector
- **Must be sourced, not executed**: `source script/settings.sh`
- Inspects `$PWD` for directory patterns: `/dev/`, `/staging/`, `/prod/`
- Sources `settings.txt` first, then the matching `settings.<env>.sh`
- Exports all variables so subshells inherit them
- Fails with clear error if environment cannot be detected

#### `settings.dev.sh` / `settings.staging.sh` / `settings.prod.sh`
- **GENERATED BY ANSIBLE** — do not edit manually
- **Git-ignored** — not committed to the repository
- Contain environment-specific overrides:
  ```bash
  ENV=development
  FRONTEND_PORT=15100
  BACKEND_PORT=15101
  NODE_ENV=development
  DEBUG=true
  ```

#### Port Allocation by Environment

| Environment | Frontend Port | Backend Port | Debug |
|-------------|--------------|--------------|-------|
| dev         | 15100        | 15101        | true  |
| staging     | 17100        | 17101        | false |
| prod        | 20100        | 20101        | false |

- Ports are assigned in `site-management/group_vars/all/ports.yml`
- Each site gets a 10-port block. Site N offset = N * 10
- **Never hardcode ports.** Always read from settings files.

#### `manage.sh` — Main Entry Point
Usage:
```bash
./script/manage.sh --frontend    # Start Vite dev server
./script/manage.sh --backend     # Start Flask dev server
./script/manage.sh --gunicorn    # Start Gunicorn (production)
```
- Dispatches to the appropriate `run-*.sh` script
- Each run script sources `settings.sh` internally

#### `generate-env.sh` — .env File Generator
- Sources `settings.sh` to auto-detect environment
- Generates `frontend/.env` with `VITE_*` prefixed variables
- Generates root `.env` with backend variables
- Uses `set -euo pipefail` (strict error handling)
- **Both generated files have "do not edit" headers**

#### `run-backend.sh` — Flask Launcher
- Calls `generate-env.sh` to ensure .env files exist
- Exports `FLASK_SECRET_KEY`, `BACKEND_HOST`, `BACKEND_PORT`, `DEBUG`, etc.
- Runs: `python3 backend/app.py`

#### `run-frontend.sh` — Vite Launcher
- Calls `generate-env.sh` to ensure .env files exist
- Changes to `frontend/` directory
- Runs: `npm run dev`

#### `run-gunicorn.sh` — Production Launcher
- Calls `generate-env.sh` to ensure .env files exist
- Exports backend environment variables
- Runs: `gunicorn -k eventlet -w $WORKERS -b $BACKEND_HOST:$BACKEND_PORT app:app`
- Working directory: `backend/`

---

### 4.4 Systemd — `/systemd/`

#### `site.service.example`
```ini
[Unit]
Description=Gunicorn for <site-name>
After=network.target

[Service]
User=apache
Group=apache
WorkingDirectory=/var/www/html/<site-name>/backend
EnvironmentFile=/etc/systemd/system/<site-name>.env
ExecStart=/usr/local/bin/gunicorn -k eventlet -w 3 -b 127.0.0.1:<backend-port> app:app

[Install]
WantedBy=multi-user.target
```

#### `site.env.example`
```bash
ENV=production
BACKEND_PORT=20101
FRONTEND_PORT=20100
BACKEND_HOST=127.0.0.1
```

- These are reference examples only.
- **Actual systemd files are generated by Ansible** during deployment.
- Always runs as `apache:apache` user.
- Backend binds to `127.0.0.1` (localhost only — Apache reverse-proxies public traffic).

---

### 4.5 Git Configuration

#### `.gitignore` (project root)
```
script/settings.*.sh        # Ansible-generated environment settings
.env                         # Generated root environment file
frontend/.env                # Generated frontend environment file
frontend/node_modules/       # NPM packages
frontend/dist/               # Built frontend assets
backend/__pycache__/         # Python bytecode cache
backend/*.pyc                # Python compiled files
.idea/                       # JetBrains IDE
.vscode/                     # VS Code
*.swp                        # Vim swap files
*.swo                        # Vim swap files
```

#### Branch Strategy
- `main` — production branch
- `staging` — staging environment
- `dev` — development branch
- Promotion flow: `dev` -> `staging` -> `main`
- Git worktrees supported for simultaneous branch access

---

## 5. Design Patterns and Conventions

### 5.1 Environment Detection from Directory Path
The core pattern: **the working directory determines the environment.** When using git worktrees, each branch lives in its own directory (`/path/to/site/dev/`, `/path/to/site/staging/`, `/path/to/site/prod/`). The `settings.sh` script inspects `$PWD` for these path segments and sources the correct settings file. This eliminates manual environment switching.

### 5.2 Ansible as Single Source of Truth for Infrastructure
- **Ansible generates** the `settings.*.sh` files — the app never defines its own ports
- **Ansible manages** vhosts, SSL certificates, and systemd services
- **The app only reads** environment variables — it never knows about infrastructure directly
- This separation means you can re-port or re-deploy a site by changing one Ansible variable

### 5.3 Layered Configuration (Shared + Override)
Configuration follows a strict hierarchy:
1. `settings.txt` — shared non-secret defaults (version-controlled)
2. `settings.<env>.sh` — environment-specific overrides (Ansible-generated, git-ignored)
3. `.env` files — generated from the above for tools that need dotenv format (Vite)

### 5.4 No Secrets in Version Control
- `settings.txt` contains **only** non-secret defaults
- Secrets live in Ansible Vault (`site-management/group_vars/all/vault.yml`)
- Ansible injects secrets into `settings.*.sh` at deploy time
- `.env` files are git-ignored

### 5.5 Backend Binds to Localhost Only
- Flask/Gunicorn always binds to `127.0.0.1`
- Apache reverse-proxies public traffic to the local port
- This is a security boundary — the app is never directly exposed to the internet

### 5.6 CORS Driven by Configuration
- Allowed CORS domains come from `ALLOWED_CORS_DOMAINS` environment variable
- Parsed as comma-separated list in `app.py`
- Empty by default (no cross-origin access unless configured)

### 5.7 Health Check as Connectivity Proof
- Every site MUST have `GET /api/health` returning `{"status": "healthy", "environment": "<ENV>"}`
- The frontend `App.jsx` demonstrates fetching this endpoint
- This endpoint is used for smoke testing and monitoring

---

## 6. How to Create a New Site from This Template

### Step 1 — Clone the Template
```bash
cp -r /opt/operations/platform-template /opt/operations/<new-site-name>
cd /opt/operations/<new-site-name>
rm -rf .git
git init
git checkout -b main
git add .
git commit -m "feat: scaffold <new-site-name> from platform-template"
git checkout -b staging
git checkout -b dev
```

### Step 2 — Register the Site in Ansible
Add an entry to `/opt/operations/site-management/group_vars/all/ports.yml`:
```yaml
website_sites:
  <new-site-name>:
    domain: <subdomain>.<domain>.com
    site_index: <next_available_index>
    admin_email: admin@example.com
    webroot: /var/www/html/<new-site-name>
    has_frontend: true
    ports:
      dev:
        frontend: <15100 + (site_index * 10)>
        backend: <15101 + (site_index * 10)>
      staging:
        frontend: <17100 + (site_index * 10)>
        backend: <17101 + (site_index * 10)>
      prod:
        frontend: <20100 + (site_index * 10)>
        backend: <20101 + (site_index * 10)>
    vhost_prefix:
      prod: "010"
      staging: "050"
      dev: "090"
```

### Step 3 — Run Ansible to Generate Config
```bash
cd /opt/operations/site-management
ansible-playbook playbooks/deploy_site.yml -e target_group=<server_group>
```
This generates:
- `script/settings.dev.sh`, `settings.staging.sh`, `settings.prod.sh` in the site repo
- Apache vhost configs in `/etc/httpd/conf.d/`
- SSL certificates via certbot
- Systemd service file for production

### Step 4 — Develop
```bash
cd /opt/operations/<new-site-name>
git checkout dev
./script/manage.sh --backend     # Terminal 1
./script/manage.sh --frontend    # Terminal 2
```

### Step 5 — Customize
- Add Flask routes in `backend/app.py` (or create blueprints)
- Add React components in `frontend/src/components/`
- Add Python dependencies to `backend/requirements.txt`
- Add NPM dependencies to `frontend/package.json`
- Add shared non-secret config to `script/settings.txt`

---

## 7. Naming Conventions

| Item | Convention | Example |
|------|-----------|---------|
| Python modules | snake_case | `user_routes.py` |
| Python variables/functions | snake_case | `get_user_data()` |
| JavaScript variables/functions | camelCase | `getUserData()` |
| React components | PascalCase | `UserProfile.jsx` |
| Directories | kebab-case | `user-management/` |
| Bash scripts | kebab-case | `run-backend.sh` |
| Environment variables | UPPER_SNAKE_CASE | `BACKEND_PORT` |
| Frontend env vars | VITE_ prefix + UPPER_SNAKE_CASE | `VITE_API_BASE_URL` |
| Git commits | Conventional commits | `feat:`, `fix:`, `infra:`, `docs:` |

---

## 8. Technology Stack (Fixed)

| Layer | Technology | Version Constraint |
|-------|-----------|-------------------|
| Backend framework | Flask | latest stable |
| Backend CORS | flask-cors | latest stable |
| Production WSGI | Gunicorn + eventlet | latest stable |
| Frontend framework | React | ^19.x |
| Frontend build tool | Vite | ^7.x |
| Frontend routing | react-router-dom | ^7.x |
| Web server | Apache (reverse proxy) | system version |
| SSL | Let's Encrypt via certbot | system version |
| Process manager | systemd | system version |
| Configuration management | Ansible | system version |
| Version control | Git (3-branch model) | system version |

**Do not substitute** these technologies unless explicitly instructed.

---

## 9. What NOT to Change When Cloning

These files and patterns must remain intact in every site cloned from the template:

1. **`script/settings.sh`** — the auto-detector logic (environment detection from PWD)
2. **`script/manage.sh`** — the `--frontend`/`--backend`/`--gunicorn` dispatcher interface
3. **`script/generate-env.sh`** — the .env generation pipeline
4. **`script/run-backend.sh`**, **`run-frontend.sh`**, **`run-gunicorn.sh`** — launcher scripts
5. **`backend/config.py`** — the environment variable reading pattern (extend, don't replace)
6. **`GET /api/health`** — the health-check endpoint (keep it, add routes alongside it)
7. **`.gitignore`** — the exclusion of generated files
8. **The `VITE_` prefix convention** for frontend environment variables
9. **Localhost binding** (`127.0.0.1`) for backend servers
10. **The three-branch git structure** (`main`, `staging`, `dev`)

---

## 10. What to Customize When Cloning

These are the expected modification points for each new site:

| File | What to Change |
|------|---------------|
| `backend/app.py` | Add new routes, blueprints, business logic |
| `backend/config.py` | Add new config variables (extend the Config class) |
| `backend/requirements.txt` | Add project-specific Python packages |
| `frontend/src/App.jsx` | Replace health-check demo with actual UI |
| `frontend/src/components/` | Add React components |
| `frontend/package.json` | Add project-specific NPM packages |
| `frontend/index.html` | Update `<title>` and meta tags |
| `script/settings.txt` | Add shared non-secret config specific to this site |
| `README.md` | Update with site-specific documentation |

---

## 11. Integration with site-management/ (Ansible)

The platform-template does **not** stand alone. It depends on `site-management/` for:

| What Ansible Provides | Where It Goes |
|-----------------------|--------------|
| Port assignments | `script/settings.{dev,staging,prod}.sh` |
| Environment names | `script/settings.{dev,staging,prod}.sh` |
| Debug flags | `script/settings.{dev,staging,prod}.sh` |
| Apache vhost configs | `/etc/httpd/conf.d/NNN-domain.conf` |
| SSL certificates | `/etc/letsencrypt/live/NNN-domain/` |
| Systemd service files | `/etc/systemd/system/<site>.service` |
| Systemd env files | `/etc/systemd/system/<site>.env` |

**The app never generates its own infrastructure config.** Ansible is the single source of truth.

---

## 12. Quick Reference — Common Commands

```bash
# Start development (from site worktree)
./script/manage.sh --frontend        # Vite dev server
./script/manage.sh --backend         # Flask dev server

# Start production
./script/manage.sh --gunicorn        # Gunicorn with eventlet

# Regenerate .env files
./script/generate-env.sh

# Install backend dependencies
cd backend && pip install -r requirements.txt

# Install frontend dependencies
cd frontend && npm install

# Build frontend for production
cd frontend && npm run build
```

---

**Last Updated:** 2026-02-10
**Template Version:** 1.0
